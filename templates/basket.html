{% extends "base.html" %} {% block content %}
<div class="calendar-heading container text-center">
  <h1>Your Basket</h1>
  <!-- Display selected tickets and provide options for editing -->
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Race</th>
        <th>Day</th>
        <th>Ticket Type</th>
        <th>Quantity</th>
        <th>Total Price</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for index, item in basket %}
      <tr>
        <form method="post" action="{% url 'basket' %}">
          <input type="hidden" name="index" value="{{ index }}" />
          <td>{{ item.race }}</td>
          <td>{{ item.ticket_type }}</td>
          <td>{{ item.ticket_category }}</td>
          <td>{{ item.quantity }}</td>
          <td class="total-price" data-index="{{ index }}">
            £{{ item.total_price }}
          </td>
          <td>
            <a href="{% url 'edit_basket_item' index %}" class="btn btn-primary"
              >Edit</a
            >
            <a
              href="{% url 'remove_from_basket' index %}"
              class="btn btn-danger"
              >Remove</a
            >
          </td>
        </form>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <a href="{% url 'calendar' %}" class="btn btn-primary">Add More Tickets</a>
  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="action" value="buy_tickets" />
    <!-- Add a hidden input field for each item in the basket -->
    {% for index, item in basket %}
    <input
      type="hidden"
      name="basket[{{ index }}][quantity]"
      value="{{ item.quantity }}"
    />
    <input
      type="hidden"
      name="basket[{{ index }}][new_quantity_{{ index }}]"
      value="{{ item.quantity }}"
    />
    <input
      type="hidden"
      name="basket[{{ index }}][total_price]"
      value="{{ item.total_price }}"
    />
    {% endfor %}
    <button type="submit" class="btn btn-primary">Buy Tickets</button>
  </form>
  <div id="basket-data" style="display: none">
    {{ basket|json_script:"basket-data" }}
  </div>
  <script>
    const priceTable = {
      "friday-general": 70,
      "friday-grandstand": 150,
      "saturday-general": 100,
      "saturday-grandstand": 200,
      "sunday-general": 120,
      "sunday-grandstand": 250,
      "all-general": 250,
      "all-grandstand": 500,
    };

    const basketData = JSON.parse(
      document.getElementById("basket-data").textContent
    ).map((item, index) => ({
      index: index,
      race: item[1].race,
      ticket_type: item[1].ticket_type,
      ticket_category: item[1].ticket_category,
      quantity: item[1].quantity,
      total_price: item[1].total_price,
    }));

    function updateTotalPrice(event) {
      const quantityInput = event.target;
      const index = quantityInput.getAttribute("data-index");
      const item = basketData[index];
      const ticketType = item.ticket_type;
      const ticketCategory = item.ticket_category;

      const optionKey = `${ticketType}-${ticketCategory}`;
      const price = priceTable[optionKey] || 0;
      const newQuantity = parseInt(quantityInput.value); // Use updated quantity
      const total = price * newQuantity; // Use updated quantity

      const totalCell = document.querySelector(
        `.total-price[data-index="${index}"]`
      );
      totalCell.textContent = `£${total.toFixed(2)}`;
    }

    // Get all items in the basket and add event listeners to quantity inputs
    document.querySelectorAll(".quantity-input").forEach((input) => {
      input.addEventListener("input", updateTotalPrice);
    });

    // Calculate and update the total price initially
    basketData.forEach((item, index) => {
      const totalCell = document.querySelector(
        `.total-price[data-index="${index}"]`
      );
      const ticketType = item.ticket_type;
      const ticketCategory = item.ticket_category;

      const optionKey = `${ticketType}-${ticketCategory}`;
      const price = priceTable[optionKey] || 0;
      const quantity = parseInt(item.quantity);
      const total = price * quantity;

      totalCell.textContent = `£${total.toFixed(2)}`;
    });
  </script>
</div>
{% endblock %}
